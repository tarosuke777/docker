# Dockerのforwardプラグイン設定
<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

# <filter docker.hms-app.**>
#   @type parser
#   key_name log
#   <parse>
#     @type grok
#     # grok_pattern %{TIMESTAMP_ISO8601:timestamp}\s+%{WORD:level}\s+%{NUMBER:pid}\s+---\s+\[%{NOTSPACE:app}]\s+\[%{GREEDYDATA:thread}] %{JAVACLASS:class} : %{GREEDYDATA:message}
#     grok_pattern %{TIMESTAMP_ISO8601:timestamp}\s+%{WORD:level}\s+%{NUMBER:pid}\s+---\s+\[%{NOTSPACE:app}]\s+\[%{GREEDYDATA:thread}]\s*%{NOTSPACE:class}\s*:\s*%{GREEDYDATA:message}
#     suppress_parse_error_log true
#   </parse>
# </filter>


# <filter docker.hms-app.**>
#   @type rewrite_tag_filter
#   # パターン1: 日付で始まるフォーマット
#   <rule>
#     key log
#     pattern /^\d{4}-\d{2}-\d{2}/
#     tag app.log.format1
#   </rule>
#   # パターン2: その他のフォーマット
#   <rule>
#     key log
#     pattern /.*/
#     tag app.log.unparseable
#   </rule>
# </filter>

# <filter docker.hms-app.**>
#   @type parser
#   key_name log
#   <parse>
#     @type multi_format
#     <pattern>
#       format regexp
#       expression /^(?<logtime>20\d{2}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z)\s+(?<level>\w+)\s+(?<pid>\d+)\s+---\s+\[(?<app>[^\]]+)]\s+\[(?<thread>[^\]]+)]\s+(?<class>[^:]+)\s*:\s*(?<message>.*)$/
#     </pattern>
#     <pattern>
#       format none
#     </pattern>
#   </parse>
# </filter>


<filter docker.hms-app.**>
  @type parser
  key_name log
  <parse>
    @type multiline
    format_firstline /20\d{2}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z/
    format1 /^(?<logtime>20\d{2}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z)\s+(?<level>\w+)\s+(?<pid>\d+)\s+---\s+\[(?<app>[^\]]+)]\s+\[(?<thread>[^\]]+)]\s+(?<class>[^:]+)\s*:\s*(?<message>.*)$|(?<message>.*)/
  </parse>
</filter>


# <filter docker.hms-app.**>
#   @type parser
#   key_name log
#   <parse>
#     @type regexp
#     expression /^(?<logtime>20\d{2}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z)\s+(?<level>\w+)\s+(?<pid>\d+)\s+---\s+\[(?<app>[^\]]+)]\s+\[(?<thread>[^\]]+)]\s+(?<class>[^:]+)\s*:\s*(?<message>.*)$/
#     # time_key timestamp
#     # time_format %Y-%m-%dT%H:%M:%S.%L%Z
#     suppress_parse_error_log true
#   </parse>
# </filter>

# <match app.component>
#   @type rewrite_tag_filter
#   <rule>
#     key message
#     pattern /^\[(\w+)\]/
#     tag $1.${tag}
#   </rule>
# </match>

# hms-ap からのログをDatadogに送信
<match docker.hms-app.**>
  @type copy
  <store>
    @type datadog
    api_key XXXXXXXXXXXXXXXX
    host http-intake.logs.ap1.datadoghq.com
    port 443
    dd_source spring-boot-app
    dd_tags "env:production,service:hms-app"
    <buffer>
      @type memory
      flush_thread_count 4
      flush_interval 3s
      chunk_limit_size 5m
      chunk_limit_records 500
    </buffer>
  </store>

  <store>
    @type stdout
    <buffer>
      @type memory
      flush_thread_count 4
      flush_interval 3s
      chunk_limit_size 5m
      chunk_limit_records 500
    </buffer>
  </store>

</match>

  # <store>
  #   @type file
  #   path /fluentd/log/backup_app.log
  #   append true
  #   <buffer>
  #     @type file
  #     path /fluentd/log/buffer/backup_app
  #     flush_mode interval
  #     flush_interval 10s
  #   </buffer>
  # </store>


# <filter docker.hms-app.**>
#   @type rewrite_tag_filter
#   <rule>
#     key log
#     pattern /^20\d{2}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z  INFO \d+ --- \[hms] \[.*].*$/
#     tag tomcat.startup
#   </rule>
# </filter>

# hms-ap からのログをローカルファイルに送信
# <match tomcat.startup>
#   @type file
#   path /fluentd/log/app.log
#   append true
#   <format>
#     @type json
#   </format>
#   <buffer>
#     @type file
#     path /fluentd/log/buffer/app
#     flush_mode interval
#     flush_interval 10s
#     chunk_limit_size 10M
#     queue_limit_length 100
#   </buffer>
# </match>

# <source>
#   @type monitor_agent
#   bind 0.0.0.0
#   port 24220
# </source>

# エラーログをSlackに送信する設定
# <match docker.hms-app.**>
#   @type copy
#   <store>
#     @type slack
#     # webhook_url YOUR_SLACK_WEBHOOK_URL
#     webhook_url XXXXXXX
#     channel "#error-alerts"
#     username "HMS App Notifier"
#     message "Application Error: %s"
#     <format>
#       @type json
#     </format>
#   </store>
# </match>